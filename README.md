# RAG Chatbot

Это FastAPI-приложение представляет собой чат-бота с дополненной генерацией ответов (RAG), предназначенного для ответов на вопросы на основе предоставленных документов.

## Особенности

-   **FastAPI**: Современный, быстрый веб-фреймворк для создания API.
-   **RAG Pipeline**: Использует передовые модели для понимания запросов и генерации точных ответов на основе документов.
-   **Docker**: Полностью контейнеризован для легкой установки и развертывания.
-   **WebSocket**: Обеспечивает связь в реальном времени между клиентом и сервером.

## Архитектура

Приложение состоит из следующих компонентов:

-   **FastAPI App**: Основное приложение, обрабатывающее HTTP-запросы и WebSocket-соединения.
-   **PostgreSQL**: Реляционная база данных для хранения метаданных документов и чанков.
-   **OpenSearch**: Векторная база данных для хранения эмбеддингов документов и выполнения гибридного поиска.
-   **Redis**: Хранилище ключ-значение, используемое для кэширования и управления сессиями.

## Установка и запуск

### Требования

-   Docker
-   Docker Compose

### 1. Клонируйте репозиторий

```bash
git clone <URL-репозитория>
cd <имя-репозитория>
```

### 2. Настройте переменные окружения

Создайте файл `.env` из примера:

```bash
cp .env.example .env
```

Откройте `.env` в текстовом редакторе и установите необходимые значения, такие как ключи API для LLM и пароль к базе данных.

### 3. Сборка и запуск контейнеров

Запустите все сервисы с помощью Docker Compose:

```bash
docker-compose up --build -d
```

Эта команда соберет образ для FastAPI-приложения, загрузит образы для баз данных и запустит все контейнеры в фоновом режиме.

### 4. Доступ к приложению

После запуска всех контейнеров приложение будет доступно по адресу `http://localhost:7150`.

## Локальная разработка (без Docker)

Если вы предпочитаете запускать приложение локально без Docker, следуйте этим шагам:

### Требования

-   Python 3.12+
-   Poetry
-   PostgreSQL, OpenSearch и Redis (запущенные локально или в Docker).
-   Системные зависимости (для парсинга PDF): `tesseract-ocr`, `poppler-utils`, `pandoc`.
-   Активный VPN (WireGuard) или настроенные прокси-переменные в `.env`.

### 1. Установите зависимости

```bash
poetry install
```

### 2. Настройте `.env`

Для локального запуска необходимо заменить имена Docker-сервисов на `localhost` в файле `.env`:

```env
# Если базы запущены в Docker, используйте порты из docker-compose.override.yml:
DB_URI="postgresql+asyncpg://postgres:PASSWORD@localhost:7350/legal_rag_db"
OPENSEARCH_HOST=localhost
OPENSEARCH_PORT=9201
REDIS_HOST=localhost
REDIS_PORT=6379
# Отключите прокси, если VPN не требуется для локальных запросов
```

### 3. Запустите приложение

```bash
poetry run uvicorn main:app --host 0.0.0.0 --port 7150 --reload
```

## Управление данными и мониторинг

Для управления документами и контроля состояния системы используйте следующие команды. Все команды следует выполнять, когда контейнеры запущены.

### 1. Добавление и обработка документов
Скрипт `process_new_documents_test.py` сканирует целевую папку и индексирует новые файлы.

```bash
docker exec -it legal_rag_app python3 /app/process_new_documents_test.py
```

### 2. Полная очистка баз данных
Для удаления всех данных из PostgreSQL и OpenSearch (с автоматическим подтверждением):

```bash
docker exec -e RUNNING_IN_DOCKER=true legal_rag_app sh -c "echo 'yes' | python3 clear_databases.py"
```

### 3. Мониторинг логов
Для отслеживания процесса обработки документов и ошибок в реальном времени:

```bash
docker logs -f legal_rag_app
```

### 4. Контроль записей в базе данных
Для быстрой проверки количества документов и чанков в PostgreSQL:

```bash
# Список документов и количество их чанков
docker exec -it legal_rag_postgres psql -U postgres -d legal_rag_db -c "SELECT d.title, COUNT(dc.id) as chunks_count FROM documents d LEFT JOIN document_chunks dc ON d.id = dc.document_id GROUP BY d.title;"
```

Для проверки индексов в OpenSearch:
```bash
docker exec -it legal_rag_app python3 check_records.py
```

### 5. Контроль необработанных или проблемных страниц
При парсинге сложных PDF документов система отслеживает время обработки каждой страницы:

*   **Таймаут страницы**: Если страница обрабатывается дольше установленного лимита (по умолчанию 120-180с), она пропускается, а в базу данных вместо контента записывается метка: `[СТРАНИЦА X НЕ ОБРАБОТАНА: Превышен таймаут ...с]`.
*   **Остановка документа**: Если в одном документе случается **3 таймаута подряд**, обработка этого документа полностью прекращается для экономии ресурсов. Остальные страницы документа помечаются как пропущенные.

#### Проверка лога ошибок парсинга:
Информация о таких страницах сохраняется в специальный файл `failed_pages.jsonl` внутри контейнера. Чтобы просмотреть список всех проблемных страниц:

```bash
docker exec -it legal_rag_app cat /app/failed_pages.jsonl
```

Этот файл содержит формат JSON Lines с указанием документа, номера страницы, причины ошибки и времени, затраченного до прерывания.

## Порты (External / Host)

Если вы используете внешние инструменты (например, DBeaver или cURL с хоста), используйте следующие порты:

-   **FastAPI App**: `7150`
-   **PostgreSQL**: `7350`
-   **OpenSearch API**: `9201`
-   **Redis**: `6379`
-   **HTTP Proxy (VPN)**: `8888`
```
