"""
Упрощенный тест чанкинга - работает с уже скачанными файлами.
Использует локальные PDF файлы для тестирования парсинга и чанкинга.
"""
import sys
from pathlib import Path

# Добавляем корневую директорию в PYTHONPATH
sys.path.insert(0, str(Path(__file__).parent))

from src.services.document_parser import document_parser
from src.services.chunking_service import chunking_service

def test_with_sample_files():
    """
    Тестирует парсинг и чанкинг на примерах файлов.
    Создает тестовые данные вручную для демонстрации.
    """
    print("=== Тест чанкинга (упрощенная версия) ===\n")
    
    # Создаем тестовый текст, имитирующий проблемный PDF
    test_text_with_breaks = """Персональную ответственность за обеспечение пожарной безопасности на объекте несёт руководитель генподрядной организации либо другое упол- номоченное лицо. Ответственность за соблюдение мер пожарной безопасно- сти при выполнении работ субподрядными организациями на объекте возла- гается на руководителей работ этих организаций. Не допускается применять для сушки и отопления помещений нагревательные приборы, жаровни, манга- лы, электроприборы с открытыми нагревательными элементами.

В качестве заземляющих проводников должны использовать только спе- циально предназначенные для этого проводники. Магистрали заземления должны быть присоединены к заземлителям не менее чем в двух разных ме- стах и, по возможности, с противоположных сторон. Не допускается в каче- стве заземления использовать трубопроводы систем водопровода, канализа- ции, отопления и подобных систем.

Во временных зданиях и сооружениях не допускается применение светильников в открытом исполнении. Прокладка электрических сетей через ограждающие конструкции должно выполняться в металлических гильзах с уплотнением негорючими материала- ми. В конце рабочего дня обеспечить централизованное отключение электро- энергии бытовых сооружений.

7. Пусконаладочные работы

Пусконаладочные работы проводятся монтажно-наладочной организацией и должны обеспечить надежное бесперебойное выполнение ими заданных функций. Пусконаладочные работы производятся в соответствии с требованиями РД 28/3.005-2001 "Технические средства и системы охраны. Телевизионные системы видеонаблюдения (системы охранные телевизионные). Правила произ- водства и приемки работ", РСН 8.03.402-2012 "Ресурсно-сметные нормы на пусконаладочные работы. Сборник N2".

Согласно РСН 8.03.402-2012 "Ресурсно-сметные нормы на пусконаладочные работы. Сборник N2" пусконаладочные работы на данном объекте относятся к следующей категории сложности:

-система видеонаблюдения: II категория сложности.

Основная цель пусконаладочных работ - обеспечить надежное и беспере- бойное действие системы видеонаблюдения."""
    
    # Имитируем parsed_pages
    parsed_pages = [
        {
            'content': test_text_with_breaks,
            'page_number': 7,
            'type': 'text'
        }
    ]
    
    print("1. Тестовый текст загружен (имитация страницы 7)")
    print(f"   Длина текста: {len(test_text_with_breaks)} символов\n")
    
    # Создаем чанки
    print("2. Создание чанков...")
    chunks = chunking_service.create_chunks_with_metadata(
        parsed_pages=parsed_pages,
        document_id=1,
        document_title="1502-24-1-СВН.pdf",
        chunk_size=1000,
        overlap=150
    )
    
    print(f"   ✓ Создано чанков: {len(chunks)}\n")
    
    # Сохранение результатов
    output_file = "test_chunks_simple.txt"
    print(f"3. Сохранение результатов в {output_file}...\n")
    
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("=" * 80 + "\n")
        f.write("ТЕСТОВАЯ ВЕРИФИКАЦИЯ ЧАНКИНГА (УПРОЩЕННАЯ)\n")
        f.write("=" * 80 + "\n\n")
        f.write(f"Документ: 1502-24-1-СВН.pdf (тестовый текст)\n")
        f.write(f"Страница: 7\n")
        f.write(f"Чанков: {len(chunks)}\n")
        f.write(f"{'='*80}\n\n")
        
        for idx, chunk in enumerate(chunks, 1):
            f.write(f"[Chunk {idx} | Page {chunk.get('page_number', 'N/A')}]\n")
            f.write(f"{chunk['content']}\n\n")
            f.write("-" * 80 + "\n\n")
        
        # Добавляем анализ
        f.write("\n" + "=" * 80 + "\n")
        f.write("АНАЛИЗ РЕЗУЛЬТАТОВ\n")
        f.write("=" * 80 + "\n\n")
        
        f.write("Проверка исправлений:\n\n")
        
        # Проверяем, что переносы убраны
        has_hyphen_breaks = any('- ' in chunk['content'] and '\n' in chunk['content'] for chunk in chunks)
        f.write(f"1. Переносы слов (каче- ство): {'❌ НАЙДЕНЫ' if has_hyphen_breaks else '✓ ИСПРАВЛЕНЫ'}\n")
        
        # Проверяем, что одиночные переводы строк заменены
        has_single_breaks = any('\n' in chunk['content'] and '\n\n' not in chunk['content'] for chunk in chunks)
        f.write(f"2. Одиночные переводы строк: {'❌ НАЙДЕНЫ' if has_single_breaks else '✓ ИСПРАВЛЕНЫ'}\n")
        
        # Проверяем размер чанков
        avg_chunk_size = sum(len(c['content']) for c in chunks) / len(chunks) if chunks else 0
        f.write(f"3. Средний размер чанка: {avg_chunk_size:.0f} символов\n")
        
        # Проверяем наличие контекстных заголовков
        has_headers = all('Документ:' in chunk['content'] for chunk in chunks)
        f.write(f"4. Контекстные заголовки: {'✓ ПРИСУТСТВУЮТ' if has_headers else '❌ ОТСУТСТВУЮТ'}\n")
    
    print(f"✓ Результаты сохранены в {output_file}")
    print(f"\nВсего создано чанков: {len(chunks)}")
    print(f"Средний размер чанка: {sum(len(c['content']) for c in chunks) / len(chunks):.0f} символов")
    
    # Выводим первый чанк для быстрой проверки
    if chunks:
        print(f"\n{'='*80}")
        print("ПРИМЕР ПЕРВОГО ЧАНКА:")
        print(f"{'='*80}")
        print(chunks[0]['content'][:500] + "...")

if __name__ == "__main__":
    test_with_sample_files()
