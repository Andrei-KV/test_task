<!DOCTYPE html>
<html>

<head>
    <title>RAG_BOT_DEMO</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div id="chat-container">
        <div id="header">
            <img src="static/logo/g10.png" alt="DEWIAR AI Logo" width="48" height="53">
            <h2>DEMO AI</h2>
        </div>
        <ul id='messages'>
        </ul>
        <form id="form" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å" maxlength="500" />
            <div id="char-counter">0/500</div>
            <button>‚Üí</button>
        </form>
    </div>
    <script>
        // Persistent Client ID for history restoration
        var client_id = localStorage.getItem('client_id');
        if (!client_id) {
            client_id = Date.now();
            localStorage.setItem('client_id', client_id);
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        let ws;
        let loadingMessage = null;

        function connect() {
            const wsUrl = `${protocol}//${host}/api/v1/ws/${client_id}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function (event) {
                console.log("WebSocket connection established successfully.");
                var statusIndicator = document.getElementById('connection-status');
                if (statusIndicator) statusIndicator.remove();

                // Clear messages only on fresh load if needed, but here we expect history from server
                // If we reconnect, server sends full history again? 
                // Currently backend sends history on connect. Ideally we should detect if we already have it.
                // But for simplicity, we let it append (or user can refresh).
                // Actually server sends history on EVERY connect. So if we reconnect, we get duplicates.
                // FIX: Verify duplicates or clear list? simpler to clear list for now on reconnect?
                // No, better to clear list on reconnect to avoid duplicates.
                document.getElementById('messages').innerHTML = '';

                // Add welcome message
                var messages = document.getElementById('messages');
                var message = document.createElement('li');
                message.className = 'message bot-message';
                var content = document.createElement('div');
                content.className = 'message-content';
                content.innerHTML = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ, —è –æ—Ç–≤–µ—á—É –Ω–∞ –í–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã! üöÄ";
                message.appendChild(content);
                messages.appendChild(message);
            };

            ws.onclose = function (event) {
                console.log('Socket is closed. Reconnect will be attempted in 3 seconds.', event.reason);

                var messages = document.getElementById('messages');
                if (!document.getElementById('connection-status')) {
                    var status = document.createElement('li');
                    status.id = 'connection-status';
                    status.className = 'message system-message';
                    status.style.textAlign = 'center';
                    status.style.color = 'gray';
                    status.innerText = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    messages.appendChild(status);
                    messages.scrollTop = messages.scrollHeight;
                }

                setTimeout(function () {
                    connect();
                }, 3000);
            };

            ws.onmessage = function (event) {
                var messages = document.getElementById('messages');

                try {
                    const data = JSON.parse(event.data);

                    if (data.is_loading) {
                        if (loadingMessage) loadingMessage.remove();

                        loadingMessage = document.createElement('li');
                        loadingMessage.className = 'message bot-message loading-message';
                        var content = document.createElement('div');
                        content.className = 'message-content';
                        content.innerHTML = data.text;
                        loadingMessage.appendChild(content);
                        messages.appendChild(loadingMessage);
                        messages.scrollTop = messages.scrollHeight;
                        return;
                    }

                    if (loadingMessage) {
                        loadingMessage.remove();
                        loadingMessage = null;
                    }

                    var message = document.createElement('li');
                    message.className = 'message bot-message';
                    var content = document.createElement('div');
                    content.className = 'message-content';

                    if (data.text) {
                        content.innerHTML = marked.parse(data.text);
                    }
                    if (data.web_link && data.title) {
                        var linkButton = document.createElement('a');
                        linkButton.href = data.web_link;
                        linkButton.className = 'source-button';
                        linkButton.target = '_blank';
                        var buttonText = document.createElement('span');
                        buttonText.textContent = data.title;
                        linkButton.appendChild(buttonText);
                        linkButton.title = data.title;

                        var sourceContainer = document.createElement('div');
                        sourceContainer.className = 'source-container';
                        sourceContainer.appendChild(linkButton);
                        content.appendChild(sourceContainer);
                    }

                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ documents (—Å–ø–∏—Å–æ–∫), –æ—Ç–æ–±—Ä–∞–∑–∏–º –∫–Ω–æ–ø–∫–∏ (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π)
                    if (data.documents && data.documents.length > 0) {
                        var docsContainer = document.createElement('div');
                        docsContainer.className = 'documents-container';
                        docsContainer.style.marginTop = '10px';

                        var seenLinks = new Set();

                        data.documents.forEach(function (doc) {
                            // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á: —Å—Å—ã–ª–∫–∞ –ò–õ–ò –Ω–∞–∑–≤–∞–Ω–∏–µ
                            var key = doc.title;
                            if (seenLinks.has(key)) return;
                            seenLinks.add(key);

                            var linkButton = document.createElement('a');
                            linkButton.href = doc.web_link;
                            linkButton.className = 'source-button';
                            linkButton.style.display = 'block';
                            linkButton.style.marginBottom = '5px';
                            linkButton.target = '_blank';
                            linkButton.textContent = doc.title;
                            docsContainer.appendChild(linkButton);
                        });
                        content.appendChild(docsContainer);
                    }

                    message.appendChild(content);
                    messages.appendChild(message);
                    messages.scrollTop = messages.scrollHeight;
                } catch (e) {
                    // Plain text handling (History or Simple text)
                    if (loadingMessage) {
                        loadingMessage.remove();
                        loadingMessage = null;
                    }

                    var rawText = event.data;
                    var cssClass = 'bot-message';

                    // Detect history format "role: content"
                    // Use regex for robust prefix detection
                    if (/^user:\s*/i.test(rawText)) {
                        cssClass = 'user-message';
                        rawText = rawText.replace(/^user:\s*/i, '');
                    } else if (/^bot:\s*/i.test(rawText)) {
                        cssClass = 'bot-message';
                        rawText = rawText.replace(/^bot:\s*/i, '');
                    } else if (/^system:\s*/i.test(rawText)) {
                        return; // Ignore system messages
                    }

                    var message = document.createElement('li');
                    message.className = 'message ' + cssClass;
                    var content = document.createElement('div');
                    content.className = 'message-content';
                    // Use marked for history too
                    content.innerHTML = typeof marked !== 'undefined' ? marked.parse(rawText) : rawText;
                    message.appendChild(content);
                    messages.appendChild(message);
                    messages.scrollTop = messages.scrollHeight;
                }
            };
        }

        connect();

        function sendMessage(event) {
            event.preventDefault();
            var input = document.getElementById("messageText");
            if (input.value.trim() === "") {
                return;
            }

            var messages = document.getElementById('messages');
            var message = document.createElement('li');
            message.className = 'message user-message';
            var content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = input.value;
            message.appendChild(content);
            messages.appendChild(message);

            ws.send(input.value);
            input.value = '';
            updateCharCounter();
            messages.scrollTop = messages.scrollHeight; // Auto-scroll
        }

        const messageText = document.getElementById('messageText');
        const charCounter = document.getElementById('char-counter');

        function updateCharCounter() {
            const currentLength = messageText.value.length;
            charCounter.textContent = `${currentLength}/500`;
        }

        messageText.addEventListener('input', updateCharCounter);
        updateCharCounter();
    </script>
</body>

</html>